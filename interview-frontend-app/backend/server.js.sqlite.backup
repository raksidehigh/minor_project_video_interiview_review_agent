const express = require('express');
const multer = require('multer');
const cors = require('cors');
const { v4: uuidv4 } = require('uuid');
const { Storage } = require('@google-cloud/storage');
const axios = require('axios');
const path = require('path');
const fs = require('fs');
const { db, initDatabase } = require('./db');

const app = express();
const upload = multer({ storage: multer.memoryStorage() });

app.use(cors());
app.use(express.json());

// Initialize database on startup
initDatabase().catch(console.error);

// Health check endpoint
app.get('/health', (req, res) => {
  res.json({
    status: 'healthy',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    service: 'interview-backend'
  });
});

// Config
const BUCKET_NAME = 'virtual-interview-agent';
const ASSESSMENT_API_URL = process.env.ASSESSMENT_API_URL || 'http://localhost:8000/api/v1/assess';
const CREDENTIALS_PATH = path.join(__dirname, '../../service-account-key.json');

// Initialize GCS
const storage = fs.existsSync(CREDENTIALS_PATH)
  ? new Storage({ keyFilename: CREDENTIALS_PATH })
  : new Storage();

app.post('/submit-interview', express.json(), async (req, res) => {
  try {
    const { name, email, dob, user_id, is_retry } = req.body;

    if (!user_id) {
      return res.status(400).json({ error: 'user_id is required' });
    }

    // Check if user already exists
    const existingUser = db.prepare('SELECT id, email FROM users WHERE id = ?').get(user_id);
    
    if (!existingUser) {
      // New user - check for duplicate email
      const emailExists = db.prepare('SELECT id FROM users WHERE email = ?').get(email);
      if (emailExists) {
        console.log(`‚ö†Ô∏è  Duplicate email attempt: ${email}`);
        return res.status(400).json({
          error: 'Email address already used',
          message: `This email address has already been used. Please use a different email.`
        });
      }

      console.log(`üìù Creating new user: ${name} (${user_id})`);
      db.prepare('INSERT INTO users (id, name, email, dob) VALUES (?, ?, ?, ?)').run(user_id, name, email, dob);
      console.log(`‚úÖ User saved to database`);
    } else {
      console.log(`üîÑ Existing user submitting: ${name} (${user_id})`);
    }

    // Check if assessment already exists (unless forced retry)
    const existingAssessment = db.prepare('SELECT result, gcs_path FROM assessments WHERE user_id = ? ORDER BY created_at DESC LIMIT 1').get(user_id);
    
    if (existingAssessment && !is_retry) {
      console.log(`‚úÖ Returning cached assessment for ${user_id}`);
      const cachedResult = JSON.parse(existingAssessment.result);
      return res.json({ ...cachedResult, user_id, result_path: existingAssessment.gcs_path, cached: true });
    }

    // Videos already uploaded via /upload-video endpoint
    console.log(`ü§ñ Calling assessment API: ${ASSESSMENT_API_URL}`);
    const { data } = await axios.post(ASSESSMENT_API_URL, { user_id, username: name, bucket_name: BUCKET_NAME });
    console.log(`‚úÖ Assessment complete: ${data.decision}`);

    // Save result to GCS
    const bucket = storage.bucket(BUCKET_NAME);
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const resultPath = `all-api-results/${user_id}-${timestamp}.json`;
    await bucket.file(resultPath).save(JSON.stringify(data, null, 2), { contentType: 'application/json' });
    console.log(`‚úÖ Result saved to GCS: ${resultPath}`);

    // Save to DB
    const assessmentId = uuidv4();
    db.prepare('INSERT INTO assessments (id, user_id, result, gcs_path) VALUES (?, ?, ?, ?)').run(
      assessmentId, user_id, JSON.stringify(data), resultPath
    );
    console.log(`‚úÖ Assessment saved to database`);

    res.json({ ...data, user_id, result_path: resultPath });
  } catch (error) {
    console.error('Submit interview error:', error);
    res.status(500).json({ error: error.message });
  }
});

app.get('/users', (req, res) => {
  const users = db.prepare('SELECT * FROM users ORDER BY created_at DESC').all();
  res.json(users);
});

app.get('/assessments', (req, res) => {
  const assessments = db.prepare(`
    SELECT 
      a.id,
      a.user_id,
      u.name,
      u.email,
      a.gcs_path,
      a.created_at,
      json_extract(a.result, '$.decision') as decision,
      json_extract(a.result, '$.final_score') as final_score
    FROM assessments a
    LEFT JOIN users u ON a.user_id = u.id
    ORDER BY a.created_at DESC
  `).all();
  res.json(assessments);
});

app.get('/assessments/:userId', (req, res) => {
  const assessments = db.prepare('SELECT * FROM assessments WHERE user_id = ? ORDER BY created_at DESC').all(req.params.userId);
  res.json(assessments.map(a => ({ ...a, result: JSON.parse(a.result) })));
});

// Database viewer page
app.get('/admin/database', (req, res) => {
  const users = db.prepare('SELECT * FROM users ORDER BY created_at DESC').all();
  const assessments = db.prepare(`
    SELECT 
      a.*,
      u.name,
      u.email,
      json_extract(a.result, '$.decision') as decision,
      json_extract(a.result, '$.final_score') as final_score
    FROM assessments a
    LEFT JOIN users u ON a.user_id = u.id
    ORDER BY a.created_at DESC
  `).all();
  
  res.send(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Database Viewer</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        h1 { color: #333; }
        table { width: 100%; border-collapse: collapse; background: white; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th { background: #3b82f6; color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #ddd; }
        tr:hover { background: #f9f9f9; }
        .badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .pass { background: #10b981; color: white; }
        .fail { background: #ef4444; color: white; }
        .review { background: #f59e0b; color: white; }
        .section { margin: 40px 0; }
      </style>
    </head>
    <body>
      <h1>üìä Interview Database</h1>
      
      <div class="section">
        <h2>üë• Users (${users.length})</h2>
        <table>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>DOB</th>
            <th>Created At</th>
          </tr>
          ${users.map(u => `
            <tr>
              <td>${u.id}</td>
              <td>${u.name}</td>
              <td>${u.email}</td>
              <td>${u.dob || 'N/A'}</td>
              <td>${u.created_at}</td>
            </tr>
          `).join('')}
        </table>
      </div>
      
      <div class="section">
        <h2>üìù Assessments (${assessments.length})</h2>
        <table>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Decision</th>
            <th>Score</th>
            <th>Created At</th>
            <th>Result Path</th>
          </tr>
          ${assessments.map(a => `
            <tr>
              <td>${a.name}</td>
              <td>${a.email}</td>
              <td><span class="badge ${a.decision?.toLowerCase()}">${a.decision || 'N/A'}</span></td>
              <td>${a.final_score ? Math.round(a.final_score) : 'N/A'}</td>
              <td>${a.created_at}</td>
              <td><a href="https://console.cloud.google.com/storage/browser/_details/virtual-interview-agent/${a.gcs_path}" target="_blank">View</a></td>
            </tr>
          `).join('')}
        </table>
      </div>
      
      <p style="color: #666; margin-top: 40px;">
        <strong>Note:</strong> This page is only available in development. Remove before production deployment.
      </p>
    </body>
    </html>
  `);
});

const PORT = process.env.PORT || 8080;

// Temporary storage for tracking uploaded videos per user
const userUploads = new Map();

app.post('/check-email', express.json(), (req, res) => {
  try {
    const { email } = req.body;
    const existingUser = db.prepare('SELECT id, email FROM users WHERE email = ?').get(email);

    if (existingUser) {
      return res.json({ available: false, message: 'Email already used' });
    }

    res.json({ available: true });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

app.post('/upload-photo', upload.single('photo'), async (req, res) => {
  try {
    const { user_id } = req.body;
    const photoFile = req.file;

    if (!photoFile) {
      return res.status(400).json({ error: 'No photo file provided' });
    }

    if (!user_id) {
      return res.status(400).json({ error: 'user_id is required' });
    }

    console.log(`üì§ Uploading profile photo for user ${user_id}...`);

    const bucket = storage.bucket(BUCKET_NAME);
    const destPath = `${user_id}/profile_images/profile_pic.jpg`;

    await bucket.file(destPath).save(photoFile.buffer, {
      contentType: 'image/jpeg'
    });

    console.log(`‚úÖ Profile photo uploaded to GCS: ${destPath}`);

    res.json({
      success: true,
      path: `gs://${BUCKET_NAME}/${destPath}`
    });
  } catch (error) {
    console.error('Photo upload error:', error);
    res.status(500).json({ error: error.message });
  }
});

app.post('/upload-video', upload.single('video'), async (req, res) => {
  try {
    const { video_index, user_id } = req.body;
    const videoFile = req.file;

    if (!videoFile) {
      return res.status(400).json({ error: 'No video file provided' });
    }

    if (!user_id) {
      return res.status(400).json({ error: 'user_id is required' });
    }

    console.log(`üì§ Uploading video_${video_index} for user ${user_id}...`);

    // Upload directly to GCS
    const bucket = storage.bucket(BUCKET_NAME);
    const ext = videoFile.originalname.split('.').pop() || 'webm';
    const destPath = `${user_id}/interview_videos/video_${video_index}.${ext}`;

    await bucket.file(destPath).save(videoFile.buffer, {
      contentType: videoFile.mimetype
    });

    console.log(`‚úÖ Video ${video_index} uploaded to GCS: ${destPath} (${(videoFile.size / 1024 / 1024).toFixed(2)} MB)`);

    // Track uploads for this user
    if (!userUploads.has(user_id)) {
      userUploads.set(user_id, []);
    }
    userUploads.get(user_id).push({
      index: video_index,
      path: destPath,
      size: videoFile.size
    });

    res.json({
      success: true,
      path: `gs://${BUCKET_NAME}/${destPath}`,
      size: videoFile.size
    });
  } catch (error) {
    console.error('Video upload error:', error);
    res.status(500).json({ error: error.message });
  }
});

app.listen(PORT, () => console.log(`Server running on port ${PORT}`));
